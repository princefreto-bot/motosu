<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motosu Agencies</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.cinetpay.com/seamless/main.js"></script>
  <style>
    .toast{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:8px;color:white;z-index:9999;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast-success{background:#10b981}.toast-error{background:#ef4444}.toast-info{background:#3b82f6}
    .tab-active{border-bottom:3px solid #3b82f6;color:#3b82f6}
    .card{background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:20px}
    .btn-primary{background:#3b82f6;color:white;padding:12px 24px;border-radius:8px;font-weight:600;transition:all .2s}
    .btn-primary:hover{background:#2563eb}
    .btn-success{background:#10b981;color:white;padding:12px 24px;border-radius:8px;font-weight:600}
    .btn-orange{background:#f97316;color:white;padding:12px 24px;border-radius:8px;font-weight:600}
    .btn-danger{background:#ef4444;color:white;padding:10px 20px;border-radius:8px}
    .input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px}
    .input:focus{outline:none;border-color:#3b82f6}
    .stat-blue{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
    .stat-orange{background:linear-gradient(135deg,#f97316,#ea580c);color:white}
    .stat-green{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:white;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
    .radio-option{display:block;padding:10px 15px;margin:5px 0;background:#f3f4f6;border-radius:8px;cursor:pointer;transition:all .2s}
    .radio-option:hover{background:#e5e7eb}
    .radio-option.selected{background:#3b82f6;color:white}
    .checkbox-item{display:flex;align-items:center;padding:10px 15px;margin:5px 0;background:#f3f4f6;border-radius:8px;cursor:pointer}
    .checkbox-item:hover{background:#e5e7eb}
    .checkbox-item.selected{background:#10b981;color:white}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>
  <div id="modal"></div>

  <script>
    // √âtat global
    let state = {
      currentUser: null,
      currentPage: 'login',
      tasks: [],
      currentTask: null,
      taskAnswers: [],
      referrals: null,
      withdrawals: [],
      adminData: { pending: [], users: [], withdrawals: [], tasks: [], payments: [], stats: {} }
    };

    // Utilitaires
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const api = async (url, method = 'GET', data = null) => {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      const res = await fetch(url, opts);
      return res.json();
    };

    const toast = (msg, type = 'info') => {
      const div = document.createElement('div');
      div.className = `toast toast-${type}`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    };

    // Pages
    const pages = {
      login: () => `
        <div class="min-h-screen flex items-center justify-center p-4">
          <div class="card w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">üöÄ Motosu Agencies</h1>
            <form id="loginForm">
              <input type="email" class="input" placeholder="Email" id="loginEmail" required>
              <input type="password" class="input" placeholder="Mot de passe" id="loginPassword" required>
              <button type="submit" class="btn-primary w-full">Se connecter</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
              Pas de compte ? <a href="#" onclick="navigate('register')" class="text-blue-600">S'inscrire</a>
            </p>
            <hr class="my-4">
            <div class="flex gap-2">
              <button onclick="navigate('subscription')" class="flex-1 btn-orange text-sm">üí≥ Abonnement</button>
              <button onclick="navigate('about')" class="flex-1 text-gray-500 border rounded-lg py-2">√Ä propos</button>
            </div>
          </div>
        </div>
      `,

      register: () => `
        <div class="min-h-screen flex items-center justify-center p-4">
          <div class="card w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">Cr√©er un compte</h1>
            <form id="registerForm">
              <input type="text" class="input" placeholder="Nom complet" id="regName" required>
              <input type="email" class="input" placeholder="Email" id="regEmail" required>
              <input type="tel" class="input" placeholder="T√©l√©phone (ex: +225 07 XX XX XX XX)" id="regPhone" required>
              <input type="password" class="input" placeholder="Mot de passe" id="regPassword" required>
              <input type="text" class="input" placeholder="Code parrain (optionnel)" id="regReferral" value="${localStorage.getItem('referralCode') || ''}">
              <button type="submit" class="btn-primary w-full">S'inscrire</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
              D√©j√† un compte ? <a href="#" onclick="navigate('login')" class="text-blue-600">Se connecter</a>
            </p>
          </div>
        </div>
      `,

      subscription: () => `
        <div class="min-h-screen p-4">
          <div class="card max-w-2xl mx-auto">
            <h1 class="text-2xl font-bold mb-4 text-center text-blue-600">üí≥ Abonnement Motosu</h1>
            
            <div class="stat-orange rounded-xl p-6 text-center mb-6">
              <p class="text-lg opacity-90">Frais d'abonnement unique</p>
              <p class="text-4xl font-bold">4 000 FCFA</p>
            </div>

            <div class="mb-6">
              <h2 class="font-bold text-lg mb-3">‚úÖ Ce que vous obtenez :</h2>
              <ul class="space-y-3">
                <li class="flex items-start gap-3">
                  <span class="text-green-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Acc√®s illimit√© aux micro-t√¢ches</p>
                    <p class="text-sm text-gray-500">Gagnez jusqu'√† 755 FCFA par jour en compl√©tant des t√¢ches</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-green-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Programme de parrainage 3 niveaux</p>
                    <p class="text-sm text-gray-500">500 FCFA (N1) + 200 FCFA (N2) + 100 FCFA (N3) par filleul</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-green-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Retraits rapides</p>
                    <p class="text-sm text-gray-500">Mobile Money d√®s 1000 FCFA, Crypto d√®s 10000 FCFA</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-green-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Support d√©di√©</p>
                    <p class="text-sm text-gray-500">Assistance personnalis√©e pour tous les membres</p>
                  </div>
                </li>
              </ul>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 class="font-bold text-blue-600 mb-2">üí° Comment √ßa marche ?</h3>
              <ol class="text-sm text-gray-700 space-y-1">
                <li>1. Inscrivez-vous gratuitement</li>
                <li>2. Payez l'abonnement de 4000 FCFA via Mobile Money</li>
                <li>3. Votre compte est activ√© instantan√©ment</li>
                <li>4. Commencez √† gagner avec les t√¢ches et le parrainage</li>
              </ol>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
              <p class="text-sm text-yellow-800">
                <strong>‚ö° Paiement s√©curis√©</strong> via CinetPay (Orange Money, MTN Money, Moov Money, Wave)
              </p>
            </div>

            <button onclick="navigate('register')" class="btn-primary w-full mb-3">Cr√©er un compte</button>
            <button onclick="navigate('login')" class="w-full text-center text-gray-500">D√©j√† inscrit ? Se connecter</button>
          </div>
        </div>
      `,

      about: () => `
        <div class="min-h-screen p-4">
          <div class="card max-w-2xl mx-auto">
            <h1 class="text-2xl font-bold mb-4 text-blue-600">√Ä propos de Motosu Agencies</h1>
            <p class="text-gray-700 leading-relaxed mb-4">
              Motosu Agencies est une plateforme innovante d√©di√©e √† l'accompagnement des jeunes entrepreneurs et professionnels francophones en Afrique. Notre mission est de cr√©er un environnement s√©curis√© et accessible o√π chacun peut d√©velopper son r√©seau, apprendre √† travers des contenus interactifs et b√©n√©ficier d'opportunit√©s de croissance progressive.
            </p>
            <p class="text-gray-700 leading-relaxed mb-4">
              Nous croyons √† l'importance de l'engagement et de la pers√©v√©rance : chaque action sur notre plateforme contribue √† la progression personnelle et professionnelle de nos utilisateurs.
            </p>
            <p class="text-gray-700 leading-relaxed mb-6">
              Notre √©quipe, bas√©e en Afrique et en Europe, veille √† ce que l'exp√©rience utilisateur soit simple, s√©curis√©e et adapt√©e aux besoins d'une communaut√© mobile-first. Rejoignez-nous et d√©couvrez comment votre engagement peut vous permettre de progresser.
            </p>
            <button onclick="navigate('login')" class="btn-primary">Retour</button>
          </div>
        </div>
      `,

      pending: () => `
        <div class="min-h-screen p-4">
          <div class="card max-w-md mx-auto text-center">
            <div class="text-6xl mb-4">‚è≥</div>
            <h1 class="text-xl font-bold mb-2 text-orange-600">Compte de recharge - Compte inactif</h1>
            <p class="text-gray-600 mb-4">Veuillez vous abonner. Utilisez le num√©ro <strong>${state.currentUser?.phone || ''}</strong> pour le d√©p√¥t.</p>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-4 text-left">
              <p class="text-sm text-gray-600 mb-2">üí∞ Montant : <strong>4 000 FCFA</strong></p>
              <p class="text-sm text-gray-600">üì± M√©thodes : Orange Money, MTN, Wave, Moov</p>
            </div>

            <button onclick="payWithCinetPay()" class="btn-orange w-full mb-4">
              üí≥ Payer 4000 FCFA avec Mobile Money
            </button>
            <p class="text-sm text-gray-500 mb-4">Le paiement active votre compte instantan√©ment.</p>
            <button onclick="logout()" class="text-red-500">D√©connexion</button>
          </div>
        </div>
      `,

      dashboard: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-4">Bonjour, ${state.currentUser?.name} üëã</h1>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="stat-blue rounded-xl p-4 text-center">
                <p class="text-sm opacity-80">Solde Mis</p>
                <p class="text-2xl font-bold">4 000 FCFA</p>
              </div>
              <div class="stat-orange rounded-xl p-4 text-center">
                <p class="text-sm opacity-80">Gains Accumul√©s</p>
                <p class="text-2xl font-bold">${state.currentUser?.earnings || 0} FCFA</p>
              </div>
            </div>

            <div class="card mb-4">
              <h2 class="font-bold mb-3">üìä Statistiques</h2>
              <div class="grid grid-cols-3 gap-2 text-center text-sm">
                <div class="bg-gray-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-blue-600">${state.referrals?.level1?.users?.length || 0}</p>
                  <p class="text-gray-500">Filleuls N1</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-green-600">${state.referrals?.level2?.users?.length || 0}</p>
                  <p class="text-gray-500">Filleuls N2</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-purple-600">${state.currentUser?.completedTasks?.length || 0}</p>
                  <p class="text-gray-500">T√¢ches</p>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <h2 class="font-bold mb-3">üîó Votre lien de parrainage</h2>
              <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                <code class="text-sm text-blue-600">${state.currentUser?.referralCode}</code>
                <button onclick="copyReferral()" class="text-blue-600 text-sm font-bold">üìã Copier</button>
              </div>
              <p class="text-xs text-gray-500 mt-2">Partagez ce code et gagnez 500 FCFA par filleul valid√©!</p>
            </div>

            <div class="card">
              <h2 class="font-bold mb-3">üí° Actions rapides</h2>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="navigate('tasks')" class="bg-green-100 text-green-700 p-4 rounded-lg text-center">
                  <p class="text-2xl">üìã</p>
                  <p class="font-semibold">Faire des t√¢ches</p>
                </button>
                <button onclick="navigate('referrals')" class="bg-blue-100 text-blue-700 p-4 rounded-lg text-center">
                  <p class="text-2xl">üë•</p>
                  <p class="font-semibold">Parrainer</p>
                </button>
              </div>
            </div>
          </div>
        </div>
      `,

      tasks: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-2">üìã Micro-T√¢ches</h1>
            <p class="text-sm text-gray-500 mb-4">Compl√©tez des t√¢ches r√©elles et gagnez de l'argent. Max 10 t√¢ches/jour.</p>
            
            <div class="bg-green-100 text-green-800 p-3 rounded-lg mb-4 text-sm">
              <strong>Aujourd'hui :</strong> ${state.currentUser?.tasksCompletedToday?.length || 0}/10 t√¢ches compl√©t√©es
            </div>
            
            <div class="space-y-3">
              ${state.tasks.map(task => `
                <div class="card">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <span class="text-xs px-2 py-1 rounded-full ${getTaskTypeColor(task.type)}">${getTaskTypeLabel(task.type)}</span>
                      <h3 class="font-semibold mt-2">${task.title}</h3>
                      <p class="text-sm text-gray-500 mt-1">${task.description || ''}</p>
                    </div>
                    <div class="text-right ml-4">
                      <p class="font-bold text-green-600 text-lg">${task.reward} FCFA</p>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t">
                    ${state.currentUser?.completedTasks?.includes(task.id) 
                      ? '<span class="text-green-600 font-semibold">‚úì T√¢che compl√©t√©e</span>'
                      : `<button onclick="openTask('${task.id}')" class="btn-success w-full text-sm py-2">Commencer la t√¢che</button>`
                    }
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `,

      referrals: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-4">üë• Parrainage Megatrend</h1>
            
            <div class="card mb-4">
              <h2 class="font-bold mb-3">Votre code parrain</h2>
              <div class="bg-blue-100 p-4 rounded-lg text-center">
                <p class="text-2xl font-bold text-blue-600">${state.currentUser?.referralCode}</p>
                <button onclick="copyReferral()" class="text-blue-600 mt-2 text-sm font-semibold">üìã Copier le lien complet</button>
              </div>
            </div>

            <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg mb-4">
              <p class="text-sm text-orange-800">
                <strong>üí° Astuce :</strong> Partagez votre lien sur WhatsApp, Facebook et avec vos amis pour maximiser vos gains!
              </p>
            </div>

            <div class="grid gap-4">
              <div class="card border-l-4 border-green-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-green-600">ü•á Niveau 1 (Direct)</h3>
                    <p class="text-sm text-gray-500">500 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-2xl font-bold">${state.referrals?.level1?.users?.length || 0}</p>
                    <p class="text-green-600 font-bold">${state.referrals?.level1?.total || 0} FCFA</p>
                  </div>
                </div>
                ${state.referrals?.level1?.users?.length > 0 ? `
                  <div class="mt-3 pt-3 border-t">
                    <p class="text-xs text-gray-500 mb-2">Vos filleuls :</p>
                    <div class="flex flex-wrap gap-1">
                      ${state.referrals.level1.users.map(u => `
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">${u.name} ${u.status === 'validated' ? '‚úì' : '‚è≥'}</span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>

              <div class="card border-l-4 border-blue-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-blue-600">ü•à Niveau 2</h3>
                    <p class="text-sm text-gray-500">200 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-2xl font-bold">${state.referrals?.level2?.users?.length || 0}</p>
                    <p class="text-blue-600 font-bold">${state.referrals?.level2?.total || 0} FCFA</p>
                  </div>
                </div>
              </div>

              <div class="card border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-purple-600">ü•â Niveau 3</h3>
                    <p class="text-sm text-gray-500">100 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-2xl font-bold">${state.referrals?.level3?.users?.length || 0}</p>
                    <p class="text-purple-600 font-bold">${state.referrals?.level3?.total || 0} FCFA</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mt-4">
              <h3 class="font-bold mb-2">üìä Total des gains parrainage</h3>
              <p class="text-2xl font-bold text-orange-600">
                ${(state.referrals?.level1?.total || 0) + (state.referrals?.level2?.total || 0) + (state.referrals?.level3?.total || 0)} FCFA
              </p>
            </div>
          </div>
        </div>
      `,

      withdraw: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-4">üí∞ Retraits</h1>
            
            <div class="card mb-4">
              <div class="stat-orange rounded-lg p-4 text-center mb-4">
                <p class="text-sm opacity-80">Solde disponible pour retrait</p>
                <p class="text-2xl font-bold">${state.currentUser?.earnings || 0} FCFA</p>
              </div>

              <form id="withdrawForm">
                <label class="block text-sm font-medium text-gray-700 mb-2">M√©thode de retrait</label>
                <select id="withdrawMethod" class="input">
                  <option value="orange">Orange Money (min 1000 FCFA)</option>
                  <option value="mtn">MTN Mobile Money (min 1000 FCFA)</option>
                  <option value="wave">Wave (min 1000 FCFA)</option>
                  <option value="moov">Moov Money (min 1000 FCFA)</option>
                  <option value="crypto">Crypto USDT (min 10000 FCFA)</option>
                </select>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Montant</label>
                <input type="number" id="withdrawAmount" class="input" placeholder="Montant en FCFA" min="1000" required>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Num√©ro/Adresse de paiement</label>
                <input type="text" id="withdrawDetails" class="input" placeholder="Ex: +225 07 XX XX XX XX ou adresse USDT TRC20" required>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Capture d'√©cran (obligatoire)</label>
                <input type="file" id="withdrawScreenshot" accept="image/*" class="input" required>
                <p class="text-xs text-gray-500 mb-4">Joindre une capture d'√©cran de votre compte Mobile Money ou wallet</p>
                
                <button type="submit" class="btn-orange w-full">Demander un retrait</button>
              </form>
            </div>

            <div class="card">
              <h2 class="font-bold mb-3">üìú Historique des retraits</h2>
              ${state.withdrawals.length === 0 ? '<p class="text-gray-500 text-sm text-center py-4">Aucun retrait effectu√©</p>' : `
                <div class="space-y-2">
                  ${state.withdrawals.map(w => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <div>
                        <p class="font-semibold">${w.amount} FCFA</p>
                        <p class="text-xs text-gray-500">${w.method} - ${new Date(w.createdAt).toLocaleDateString('fr-FR')}</p>
                      </div>
                      <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColor(w.status)}">${getStatusLabel(w.status)}</span>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `,

      admin: () => `
        <div class="min-h-screen bg-gray-100">
          <div class="bg-blue-600 text-white p-4">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
              <h1 class="text-xl font-bold">‚öôÔ∏è Admin Panel</h1>
              <button onclick="logout()" class="text-sm bg-white/20 px-3 py-1 rounded">D√©connexion</button>
            </div>
          </div>
          
          <div class="p-4 max-w-4xl mx-auto">
            <div class="flex gap-2 overflow-x-auto mb-4 pb-2">
              <button onclick="setAdminTab('stats')" class="px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-stats">üìä Stats</button>
              <button onclick="setAdminTab('pending')" class="px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-pending">‚è≥ En attente</button>
              <button onclick="setAdminTab('users')" class="px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-users">üë• Utilisateurs</button>
              <button onclick="setAdminTab('withdrawals')" class="px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-withdrawals">üí∞ Retraits</button>
              <button onclick="setAdminTab('tasks')" class="px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-tasks">üìã T√¢ches</button>
            </div>
            
            <div id="adminContent"></div>
          </div>
        </div>
      `
    };

    // Navigation et rendu
    function renderNav() {
      return `
        <div class="bg-white shadow-sm sticky top-0 z-50">
          <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <h1 class="text-lg font-bold text-blue-600">üöÄ Motosu</h1>
            <button onclick="logout()" class="text-red-500 text-sm">D√©connexion</button>
          </div>
          <div class="flex overflow-x-auto border-t">
            <button onclick="navigate('dashboard')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'dashboard' ? 'tab-active' : ''}">üè† Accueil</button>
            <button onclick="navigate('tasks')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'tasks' ? 'tab-active' : ''}">üìã T√¢ches</button>
            <button onclick="navigate('referrals')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'referrals' ? 'tab-active' : ''}">üë• Parrainage</button>
            <button onclick="navigate('withdraw')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'withdraw' ? 'tab-active' : ''}">üí∞ Retrait</button>
          </div>
        </div>
      `;
    }

    function getTaskTypeColor(type) {
      const colors = {
        sondage: 'bg-blue-100 text-blue-600',
        verification: 'bg-yellow-100 text-yellow-600',
        classification: 'bg-purple-100 text-purple-600',
        transcription: 'bg-green-100 text-green-600'
      };
      return colors[type] || 'bg-gray-100 text-gray-600';
    }

    function getTaskTypeLabel(type) {
      const labels = {
        sondage: 'üìä Sondage',
        verification: '‚úÖ V√©rification',
        classification: 'üìÅ Classification',
        transcription: '‚úçÔ∏è Transcription'
      };
      return labels[type] || type;
    }

    function getStatusColor(status) {
      const colors = {
        pending: 'bg-yellow-100 text-yellow-600',
        approved: 'bg-green-100 text-green-600',
        rejected: 'bg-red-100 text-red-600',
        validated: 'bg-green-100 text-green-600'
      };
      return colors[status] || 'bg-gray-100 text-gray-600';
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'En attente',
        approved: 'Approuv√©',
        rejected: 'Refus√©',
        validated: 'Valid√©'
      };
      return labels[status] || status;
    }

    async function navigate(page) {
      state.currentPage = page;
      
      if (state.currentUser && state.currentUser.status === 'validated') {
        if (['dashboard', 'referrals'].includes(page)) {
          state.referrals = await api(`/api/referrals/${state.currentUser.id}`);
        }
        if (page === 'tasks') {
          state.tasks = await api('/api/tasks');
        }
        if (page === 'withdraw') {
          state.withdrawals = await api(`/api/withdrawals/user/${state.currentUser.id}`);
        }
      }
      
      render();
    }

    function render() {
      const app = $('#app');
      if (pages[state.currentPage]) {
        app.innerHTML = pages[state.currentPage]();
        attachEventListeners();
      }
    }

    function attachEventListeners() {
      const loginForm = $('#loginForm');
      if (loginForm) {
        loginForm.onsubmit = async (e) => {
          e.preventDefault();
          const res = await api('/api/login', 'POST', {
            email: $('#loginEmail').value,
            password: $('#loginPassword').value
          });
          if (res.error) {
            toast(res.error, 'error');
          } else {
            state.currentUser = res.user;
            localStorage.setItem('userId', res.user.id);
            if (res.user.isAdmin) {
              navigate('admin');
            } else if (res.user.status === 'validated') {
              navigate('dashboard');
            } else {
              navigate('pending');
            }
            toast('Connexion r√©ussie!', 'success');
          }
        };
      }

      const registerForm = $('#registerForm');
      if (registerForm) {
        registerForm.onsubmit = async (e) => {
          e.preventDefault();
          const res = await api('/api/register', 'POST', {
            name: $('#regName').value,
            email: $('#regEmail').value,
            phone: $('#regPhone').value,
            password: $('#regPassword').value,
            referralCode: $('#regReferral').value
          });
          if (res.error) {
            toast(res.error, 'error');
          } else {
            state.currentUser = res.user;
            localStorage.setItem('userId', res.user.id);
            localStorage.removeItem('referralCode');
            navigate('pending');
            toast('Inscription r√©ussie! Veuillez activer votre compte.', 'success');
          }
        };
      }

      const withdrawForm = $('#withdrawForm');
      if (withdrawForm) {
        withdrawForm.onsubmit = async (e) => {
          e.preventDefault();
          const file = $('#withdrawScreenshot').files[0];
          if (!file) {
            toast('Capture d\'√©cran obligatoire', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = async () => {
            const method = $('#withdrawMethod').value;
            const res = await api('/api/withdraw', 'POST', {
              userId: state.currentUser.id,
              amount: parseInt($('#withdrawAmount').value),
              method: method,
              details: $('#withdrawDetails').value,
              screenshot: reader.result
            });
            if (res.error) {
              toast(res.error, 'error');
            } else {
              toast('Demande de retrait envoy√©e!', 'success');
              state.currentUser = await api(`/api/user/${state.currentUser.id}`);
              navigate('withdraw');
            }
          };
          reader.readAsDataURL(file);
        };
      }
      
      if (state.currentPage === 'admin') {
        setAdminTab('stats');
      }
    }

    // Ouvrir une t√¢che
    async function openTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;
      
      state.currentTask = task;
      state.taskAnswers = [];
      
      const modal = $('#modal');
      modal.innerHTML = renderTaskModal(task);
    }

    function renderTaskModal(task) {
      let content = '';
      
      if (task.type === 'sondage') {
        content = `
          <div class="space-y-6">
            ${task.content.questions.map((q, i) => `
              <div class="question-block" data-index="${i}">
                <p class="font-semibold mb-3">${i + 1}. ${q.q}</p>
                <div class="space-y-2">
                  ${q.options.map((opt, j) => `
                    <label class="radio-option block" data-question="${i}" data-option="${j}">
                      <input type="radio" name="q${i}" value="${opt}" class="hidden">
                      ${opt}
                    </label>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else if (task.type === 'verification') {
        content = `
          <p class="text-gray-600 mb-4">${task.content.instruction}</p>
          <div class="space-y-2">
            ${task.content.items.map((item, i) => `
              <label class="checkbox-item" data-index="${i}">
                <input type="checkbox" class="mr-3" data-index="${i}">
                <span>${item.email || item.phone}</span>
              </label>
            `).join('')}
          </div>
        `;
      } else if (task.type === 'classification') {
        content = `
          <p class="text-gray-600 mb-4">S√©lectionnez la bonne cat√©gorie pour chaque √©l√©ment.</p>
          <div class="space-y-4">
            ${task.content.items.map((item, i) => `
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="font-semibold mb-2">${item.name}</p>
                <select class="input mb-0" data-index="${i}">
                  <option value="">-- Choisir une cat√©gorie --</option>
                  ${task.content.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
              </div>
            `).join('')}
          </div>
        `;
      } else if (task.type === 'transcription') {
        content = `
          <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <p class="font-semibold mb-2">Texte √† transcrire :</p>
            <p class="text-gray-700 italic">"${task.content.text}"</p>
          </div>
          <textarea id="transcriptionText" class="input h-32" placeholder="Recopiez le texte exactement..."></textarea>
          <p class="text-xs text-gray-500">Minimum ${task.content.minLength} caract√®res</p>
        `;
      }

      return `
        <div class="modal" onclick="closeTaskModal(event)">
          <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
              <div>
                <span class="text-xs px-2 py-1 rounded-full ${getTaskTypeColor(task.type)}">${getTaskTypeLabel(task.type)}</span>
                <h2 class="text-lg font-bold mt-2">${task.title}</h2>
              </div>
              <button onclick="closeTaskModal()" class="text-gray-400 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
              ${content}
            </div>
            
            <div class="flex gap-3">
              <button onclick="closeTaskModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Annuler</button>
              <button onclick="submitTask('${task.id}')" class="flex-1 btn-success py-3">Valider (+${task.reward} FCFA)</button>
            </div>
          </div>
        </div>
      `;
    }

    function closeTaskModal(event) {
      if (event && event.target !== event.currentTarget) return;
      $('#modal').innerHTML = '';
      state.currentTask = null;
    }

    async function submitTask(taskId) {
      const task = state.currentTask;
      if (!task) return;
      
      let answers = [];
      let valid = true;
      
      if (task.type === 'sondage') {
        task.content.questions.forEach((q, i) => {
          const selected = document.querySelector(`input[name="q${i}"]:checked`);
          if (selected) {
            answers.push(selected.value);
          }
        });
        if (answers.length < task.content.questions.length) {
          toast('Veuillez r√©pondre √† toutes les questions', 'error');
          return;
        }
      } else if (task.type === 'verification') {
        const checkboxes = $$('.checkbox-item input:checked');
        checkboxes.forEach(cb => answers.push(cb.dataset.index));
        if (answers.length === 0) {
          toast('Veuillez s√©lectionner au moins un √©l√©ment', 'error');
          return;
        }
      } else if (task.type === 'classification') {
        const selects = $$('.modal-content select');
        selects.forEach(sel => {
          if (sel.value) answers.push(sel.value);
        });
        if (answers.length < task.content.items.length) {
          toast('Veuillez classifier tous les √©l√©ments', 'error');
          return;
        }
      } else if (task.type === 'transcription') {
        const text = $('#transcriptionText').value.trim();
        if (text.length < task.content.minLength) {
          toast(`Le texte doit contenir au moins ${task.content.minLength} caract√®res`, 'error');
          return;
        }
        answers = text;
      }
      
      const res = await api(`/api/tasks/${taskId}/complete`, 'POST', {
        userId: state.currentUser.id,
        answers: answers
      });
      
      if (res.error) {
        toast(res.error, 'error');
      } else {
        toast(`+${res.reward} FCFA gagn√©s!`, 'success');
        closeTaskModal();
        state.currentUser = await api(`/api/user/${state.currentUser.id}`);
        navigate('tasks');
      }
    }

    // Event delegation pour les options radio
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('radio-option')) {
        const question = e.target.dataset.question;
        $$(`[data-question="${question}"]`).forEach(el => el.classList.remove('selected'));
        e.target.classList.add('selected');
        e.target.querySelector('input').checked = true;
      }
      if (e.target.closest('.checkbox-item')) {
        const item = e.target.closest('.checkbox-item');
        item.classList.toggle('selected');
      }
    });

    function copyReferral() {
      const link = `${window.location.origin}?ref=${state.currentUser.referralCode}`;
      navigator.clipboard.writeText(link);
      toast('Lien de parrainage copi√©!', 'success');
    }

    function logout() {
      state.currentUser = null;
      localStorage.removeItem('userId');
      navigate('login');
      toast('D√©connexion r√©ussie', 'info');
    }

    // CinetPay
    function payWithCinetPay() {
      api('/api/payment/init', 'POST', { userId: state.currentUser.id }).then(data => {
        if (data.error) {
          toast(data.error, 'error');
          return;
        }
        
        CinetPay.setConfig({
          apikey: '1998578076686c3f77308a92.08703757',
          site_id: 105901112,
          notify_url: window.location.origin + '/api/payment/notify',
          mode: 'PRODUCTION'
        });
        
        CinetPay.getCheckout({
          transaction_id: data.transactionId,
          amount: 4000,
          currency: 'XOF',
          channels: 'ALL',
          description: 'Abonnement Motosu Agencies',
          customer_name: state.currentUser.name,
          customer_email: state.currentUser.email,
          customer_phone_number: state.currentUser.phone,
          customer_address: 'Afrique',
          customer_city: 'Abidjan',
          customer_country: 'CI'
        });
        
        CinetPay.waitResponse(async (data) => {
          if (data.status === 'ACCEPTED') {
            await api('/api/payment/confirm', 'POST', { 
              transactionId: data.transaction_id, 
              userId: state.currentUser.id 
            });
            state.currentUser = await api(`/api/user/${state.currentUser.id}`);
            toast('Paiement r√©ussi! Compte activ√©.', 'success');
            navigate('dashboard');
          }
        });
        
        CinetPay.onError((data) => {
          toast('Paiement √©chou√© ou annul√©', 'error');
        });
      });
    }

    // Admin
    let currentAdminTab = 'stats';

    async function setAdminTab(tab) {
      currentAdminTab = tab;
      $$('[id^="tab-"]').forEach(el => el.classList.remove('bg-blue-600', 'text-white'));
      $(`#tab-${tab}`)?.classList.add('bg-blue-600', 'text-white');
      
      const content = $('#adminContent');
      if (!content) return;
      
      if (tab === 'stats') {
        state.adminData.stats = await api('/api/admin/stats');
        content.innerHTML = renderAdminStats();
      } else if (tab === 'pending') {
        state.adminData.pending = await api('/api/admin/pending');
        content.innerHTML = renderAdminPending();
      } else if (tab === 'users') {
        state.adminData.users = await api('/api/admin/users');
        content.innerHTML = renderAdminUsers();
      } else if (tab === 'withdrawals') {
        state.adminData.withdrawals = await api('/api/admin/withdrawals');
        content.innerHTML = renderAdminWithdrawals();
      } else if (tab === 'tasks') {
        state.adminData.tasks = await api('/api/admin/tasks');
        content.innerHTML = renderAdminTasks();
      }
    }

    function renderAdminStats() {
      const s = state.adminData.stats;
      return `
        <div class="grid grid-cols-2 gap-4">
          <div class="card text-center">
            <p class="text-3xl font-bold text-blue-600">${s.totalUsers || 0}</p>
            <p class="text-gray-500">Utilisateurs total</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-green-600">${s.validatedUsers || 0}</p>
            <p class="text-gray-500">Comptes actifs</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-yellow-600">${s.pendingUsers || 0}</p>
            <p class="text-gray-500">En attente</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-orange-600">${s.totalPayments || 0} FCFA</p>
            <p class="text-gray-500">Total paiements</p>
          </div>
          <div class="card text-center col-span-2">
            <p class="text-3xl font-bold text-purple-600">${s.totalWithdrawals || 0} FCFA</p>
            <p class="text-gray-500">Retraits approuv√©s</p>
          </div>
        </div>
      `;
    }

    function renderAdminPending() {
      if (state.adminData.pending.length === 0) {
        return '<div class="card text-center text-gray-500 py-8">Aucun compte en attente de validation</div>';
      }
      return state.adminData.pending.map(u => `
        <div class="card mb-3">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-bold">${u.name}</p>
              <p class="text-sm text-gray-500">${u.email}</p>
              <p class="text-sm text-gray-500">${u.phone}</p>
              <p class="text-xs text-gray-400 mt-1">Inscrit le ${new Date(u.createdAt).toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="validateUser('${u.id}')" class="btn-success text-xs px-3 py-2">‚úì Valider</button>
              <button onclick="rejectUser('${u.id}')" class="btn-danger text-xs px-3 py-2">‚úó Refuser</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAdminUsers() {
      return `
        <div class="card">
          <p class="text-sm text-gray-500 mb-3">Total: ${state.adminData.users.length} utilisateurs</p>
          <div class="space-y-2">
            ${state.adminData.users.map(u => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                <div>
                  <p class="font-semibold">${u.name} ${u.isAdmin ? 'üëë' : ''}</p>
                  <p class="text-xs text-gray-500">${u.email} | ${u.earnings} FCFA gagn√©s</p>
                </div>
                <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColor(u.status)}">${getStatusLabel(u.status)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderAdminWithdrawals() {
      if (state.adminData.withdrawals.length === 0) {
        return '<div class="card text-center text-gray-500 py-8">Aucune demande de retrait</div>';
      }
      return state.adminData.withdrawals.map(w => `
        <div class="card mb-3">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-bold text-lg">${w.amount} FCFA</p>
              <p class="text-sm text-gray-600">${w.userName}</p>
              <p class="text-sm text-gray-500">${w.method} - ${w.details}</p>
              <p class="text-xs text-gray-400">${new Date(w.createdAt).toLocaleDateString('fr-FR')}</p>
              ${w.screenshot ? `<img src="${w.screenshot}" class="w-20 h-20 object-cover mt-2 rounded cursor-pointer border" onclick="window.open('${w.screenshot}')">` : ''}
            </div>
            <div class="flex flex-col gap-2 items-end">
              <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColor(w.status)}">${getStatusLabel(w.status)}</span>
              ${w.status === 'pending' ? `
                <button onclick="approveWithdraw('${w.id}')" class="btn-success text-xs px-3 py-1">Approuver</button>
                <button onclick="rejectWithdraw('${w.id}')" class="btn-danger text-xs px-3 py-1">Refuser</button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAdminTasks() {
      return `
        <div class="card mb-4">
          <h3 class="font-bold mb-3">Ajouter une t√¢che</h3>
          <select id="taskType" class="input">
            <option value="sondage">üìä Sondage</option>
            <option value="verification">‚úÖ V√©rification</option>
            <option value="classification">üìÅ Classification</option>
            <option value="transcription">‚úçÔ∏è Transcription</option>
          </select>
          <input type="text" id="taskTitle" class="input" placeholder="Titre de la t√¢che">
          <input type="number" id="taskReward" class="input" placeholder="R√©compense (FCFA)">
          <textarea id="taskDesc" class="input" placeholder="Description"></textarea>
          <button onclick="addTask()" class="btn-primary w-full">Ajouter la t√¢che</button>
        </div>
        <h3 class="font-bold mb-3">T√¢ches existantes (${state.adminData.tasks.length})</h3>
        <div class="space-y-2">
          ${state.adminData.tasks.map(t => `
            <div class="card flex justify-between items-center">
              <div>
                <span class="text-xs px-2 py-1 rounded-full ${getTaskTypeColor(t.type)}">${getTaskTypeLabel(t.type)}</span>
                <p class="font-semibold mt-1">${t.title}</p>
                <p class="text-green-600 font-bold">${t.reward} FCFA</p>
              </div>
              <button onclick="deleteTask('${t.id}')" class="btn-danger text-xs">Supprimer</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function validateUser(userId) {
      await api(`/api/admin/validate/${userId}`, 'POST');
      toast('Utilisateur valid√©! Commissions de parrainage vers√©es.', 'success');
      setAdminTab('pending');
    }

    async function rejectUser(userId) {
      await api(`/api/admin/reject/${userId}`, 'POST');
      toast('Utilisateur refus√©', 'info');
      setAdminTab('pending');
    }

    async function approveWithdraw(id) {
      await api(`/api/admin/withdraw/approve/${id}`, 'POST');
      toast('Retrait approuv√©!', 'success');
      setAdminTab('withdrawals');
    }

    async function rejectWithdraw(id) {
      await api(`/api/admin/withdraw/reject/${id}`, 'POST');
      toast('Retrait refus√©, montant rembours√©', 'info');
      setAdminTab('withdrawals');
    }

    async function addTask() {
      const type = $('#taskType').value;
      const title = $('#taskTitle').value;
      const reward = $('#taskReward').value;
      const description = $('#taskDesc').value;
      
      if (!title || !reward) {
        toast('Veuillez remplir tous les champs', 'error');
        return;
      }
      
      const res = await api('/api/admin/tasks', 'POST', {
        type,
        title,
        reward,
        description,
        content: {}
      });
      if (res.success) {
        toast('T√¢che ajout√©e!', 'success');
        setAdminTab('tasks');
      }
    }

    async function deleteTask(id) {
      if (!confirm('Supprimer cette t√¢che ?')) return;
      await api(`/api/admin/tasks/${id}`, 'DELETE');
      toast('T√¢che supprim√©e', 'info');
      setAdminTab('tasks');
    }

    // Init
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref) {
        localStorage.setItem('referralCode', ref);
        toast('Code parrain enregistr√©: ' + ref, 'info');
      }

      const userId = localStorage.getItem('userId');
      if (userId) {
        try {
          const user = await api(`/api/user/${userId}`);
          if (user && !user.error) {
            state.currentUser = user;
            if (user.isAdmin) {
              navigate('admin');
            } else if (user.status === 'validated') {
              navigate('dashboard');
            } else {
              navigate('pending');
            }
            return;
          }
        } catch (e) {}
      }
      navigate('login');
    }

    init();
  </script>
</body>
</html>