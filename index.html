<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' *; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: cdn.jsdelivr.net cdn.tailwindcss.com www.youtube.com www.tiktok.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src 'self' fonts.gstatic.com data:; img-src 'self' data: blob: *; frame-src 'self' www.youtube.com youtube.com www.tiktok.com tiktok.com; connect-src 'self' *; media-src 'self' blob: *;">
  <title>Motosu Agencies - Partagez, Gagnez, Grandissez</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    .toast{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:8px;color:white;z-index:9999;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast-success{background:#10b981}.toast-error{background:#ef4444}.toast-info{background:#3b82f6}
    .tab-active{border-bottom:3px solid #3b82f6;color:#3b82f6;font-weight:600}
    .card{background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:20px}
    .btn-primary{background:#3b82f6;color:white;padding:12px 24px;border-radius:8px;font-weight:600;transition:all .2s}
    .btn-primary:hover{background:#2563eb}
    .btn-success{background:#10b981;color:white;padding:12px 24px;border-radius:8px;font-weight:600}
    .btn-success:hover{background:#059669}
    .btn-orange{background:#f97316;color:white;padding:12px 24px;border-radius:8px;font-weight:600}
    .btn-orange:hover{background:#ea580c}
    .btn-danger{background:#ef4444;color:white;padding:10px 20px;border-radius:8px}
    .btn-danger:hover{background:#dc2626}
    .input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px}
    .input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    .stat-blue{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
    .stat-orange{background:linear-gradient(135deg,#f97316,#ea580c);color:white}
    .stat-green{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal-content{background:white;border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
    .option-btn{display:block;width:100%;padding:12px 16px;margin:6px 0;background:#f3f4f6;border:2px solid transparent;border-radius:8px;cursor:pointer;transition:all .2s;text-align:left}
    .option-btn:hover{background:#e5e7eb;border-color:#d1d5db}
    .option-btn.selected{background:#3b82f6;color:white;border-color:#1d4ed8}
    .check-item{display:flex;align-items:center;padding:12px 16px;margin:6px 0;background:#f3f4f6;border:2px solid transparent;border-radius:8px;cursor:pointer;transition:all .2s}
    .check-item:hover{background:#e5e7eb}
    .check-item.selected{background:#10b981;color:white;border-color:#059669}
    .category-select{padding:10px 12px;border:2px solid #d1d5db;border-radius:6px;background:white;min-width:140px;font-size:14px}
    .category-select:focus{border-color:#3b82f6;outline:none}
    .progress-bar{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;background:#10b981;transition:width .3s}
    .video-card{border-radius:12px;overflow:hidden;background:white;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;background:#000}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%}
    .slogan{background:linear-gradient(135deg,#f97316,#ea580c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
    .question-container{background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:16px}
    .question-title{font-weight:600;color:#374151;margin-bottom:12px;font-size:15px}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Chargement de Motosu...</p>
        <p class="text-xs text-gray-400 mt-2">Le serveur gratuit peut prendre 30-60 secondes au premier chargement</p>
      </div>
    </div>
  </div>
  <div id="modal"></div>

  <script>
    // √âtat global
    let state = {
      currentUser: null,
      currentPage: 'login',
      config: { paymentNumbers: [], withdrawMethods: [], subscriptionAmount: 4000 },
      tasks: [],
      videos: [],
      currentTask: null,
      currentVideo: null,
      referrals: null,
      withdrawals: [],
      surveyAnswers: {},
      adminData: { pending: [], users: [], withdrawals: [], tasks: [], videos: [], payments: [], stats: {}, config: {} }
    };

    // Utilitaires - CORRIG√â: $ pour querySelector, $$ pour querySelectorAll
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    
    const api = async (url, method = 'GET', data = null) => {
      try {
        const token = localStorage.getItem('authToken');
        const opts = { 
          method, 
          headers: { 
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
          } 
        };
        if (data) opts.body = JSON.stringify(data);
        console.log('API Call:', method, url);
        const res = await fetch(url, opts);
        const json = await res.json();
        console.log('API Response:', json);
        return json;
      } catch (e) {
        console.error('API Error:', e);
        toast('Erreur de connexion au serveur. R√©essayez.', 'error');
        return { error: 'Erreur de connexion' };
      }
    };
    
    // Helper pour obtenir l'ID (MongoDB utilise _id)
    const getId = (obj) => obj?._id || obj?.id;

    const toast = (msg, type = 'info') => {
      const div = document.createElement('div');
      div.className = `toast toast-${type}`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    };

    // Pages
    const pages = {
      login: () => `
        <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-purple-600">
          <div class="card w-full max-w-md">
            <div class="text-center mb-6">
              <h1 class="text-3xl font-bold text-blue-600">üöÄ Motosu Agencies</h1>
              <p class="slogan text-lg mt-2">"Partagez, Gagnez, Grandissez ensemble"</p>
              <p class="text-gray-500 mt-1">Plateforme de gains en ligne</p>
            </div>
            <form id="loginForm">
              <input type="email" class="input" placeholder="Email" id="loginEmail" required>
              <input type="password" class="input" placeholder="Mot de passe" id="loginPassword" required>
              <button type="submit" class="btn-primary w-full">Se connecter</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
              Pas de compte ? <a href="#" onclick="navigate('register')" class="text-blue-600 font-semibold">S'inscrire</a>
            </p>
            <hr class="my-4">
            <button onclick="navigate('subscription')" class="w-full btn-orange mb-3">üí≥ Voir les offres d'abonnement</button>
            <button onclick="navigate('about')" class="w-full text-gray-500 border border-gray-300 rounded-lg py-3">√Ä propos de nous</button>
          </div>
        </div>
      `,

      register: () => `
        <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-green-500 to-blue-600">
          <div class="card w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-2 text-blue-600">Cr√©er un compte</h1>
            <p class="text-center text-sm text-gray-500 mb-6 slogan">"Partagez, Gagnez, Grandissez ensemble"</p>
            <form id="registerForm">
              <input type="text" class="input" placeholder="Nom complet" id="regName" required>
              <input type="email" class="input" placeholder="Email" id="regEmail" required>
              <input type="tel" class="input" placeholder="T√©l√©phone (+225 XX XX XX XX XX)" id="regPhone" required>
              <input type="password" class="input" placeholder="Mot de passe (min. 6 caract√®res)" id="regPassword" minlength="6" required>
              <input type="text" class="input" placeholder="Code parrain (optionnel)" id="regReferral" value="${localStorage.getItem('referralCode') || ''}">
              <button type="submit" class="btn-success w-full">S'inscrire gratuitement</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
              D√©j√† un compte ? <a href="#" onclick="navigate('login')" class="text-blue-600 font-semibold">Se connecter</a>
            </p>
          </div>
        </div>
      `,

      subscription: () => `
        <div class="min-h-screen p-4 bg-gray-100">
          <div class="card max-w-2xl mx-auto">
            <button onclick="navigate('login')" class="text-gray-500 mb-4">‚Üê Retour</button>
            <h1 class="text-2xl font-bold mb-2 text-center text-blue-600">üí≥ Abonnement Motosu</h1>
            <p class="text-center slogan mb-4">"Partagez, Gagnez, Grandissez ensemble"</p>
            
            <div class="stat-orange rounded-xl p-6 text-center mb-6">
              <p class="text-lg opacity-90">Frais d'abonnement unique</p>
              <p class="text-4xl font-bold">${state.config.subscriptionAmount || 4000} FCFA</p>
            </div>

            <div class="mb-6">
              <h2 class="font-bold text-lg mb-3">‚úÖ Ce que vous obtenez :</h2>
              <ul class="space-y-3">
                <li class="flex items-start gap-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-green-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Acc√®s aux micro-t√¢ches r√©mun√©r√©es</p>
                    <p class="text-sm text-gray-500">Sondages, v√©rifications, classifications...</p>
                  </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-purple-50 rounded-lg">
                  <span class="text-purple-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Vid√©os √† regarder = Argent gagn√©</p>
                    <p class="text-sm text-gray-500">YouTube et TikTok r√©mun√©r√©s</p>
                  </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                  <span class="text-blue-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Programme de parrainage 3 niveaux</p>
                    <p class="text-sm text-gray-500">2 000 FCFA (N1) + 800 FCFA (N2) + 400 FCFA (N3) par filleul</p>
                  </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-orange-50 rounded-lg">
                  <span class="text-orange-500 text-xl">‚úì</span>
                  <div>
                    <p class="font-semibold">Retraits faciles</p>
                    <p class="text-sm text-gray-500">Moov Money et Mix by Yas d√®s 10 000 FCFA</p>
                  </div>
                </li>
              </ul>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 class="font-bold text-blue-600 mb-2">üí° Comment s'abonner ?</h3>
              <ol class="text-sm text-gray-700 space-y-2">
                <li>1. Inscrivez-vous gratuitement</li>
                <li>2. Effectuez le d√©p√¥t de ${state.config.subscriptionAmount || 4000} FCFA via Mobile Money</li>
                <li>3. Envoyez la capture d'√©cran du paiement</li>
                <li>4. Votre compte est activ√© sous 24h</li>
              </ol>
            </div>

            <button onclick="navigate('register')" class="btn-primary w-full mb-3">Cr√©er un compte maintenant</button>
          </div>
        </div>
      `,

      about: () => `
        <div class="min-h-screen p-4 bg-gray-100">
          <div class="card max-w-2xl mx-auto">
            <button onclick="navigate('login')" class="text-gray-500 mb-4">‚Üê Retour</button>
            <h1 class="text-2xl font-bold mb-2 text-blue-600">√Ä propos de Motosu Agencies</h1>
            <p class="slogan mb-4">"Partagez, Gagnez, Grandissez ensemble"</p>
            <div class="prose">
              <p class="text-gray-700 leading-relaxed mb-4">
                Motosu Agencies est une plateforme innovante d√©di√©e √† l'accompagnement des jeunes entrepreneurs et professionnels francophones en Afrique. Notre mission est de cr√©er un environnement s√©curis√© et accessible o√π chacun peut d√©velopper son r√©seau, apprendre √† travers des contenus interactifs et b√©n√©ficier d'opportunit√©s de croissance progressive.
              </p>
              <p class="text-gray-700 leading-relaxed mb-4">
                Nous croyons √† l'importance de l'engagement et de la pers√©v√©rance : chaque action sur notre plateforme contribue √† la progression personnelle et professionnelle de nos utilisateurs.
              </p>
              <p class="text-gray-700 leading-relaxed mb-6">
                Notre √©quipe, bas√©e en Afrique et en Europe, veille √† ce que l'exp√©rience utilisateur soit simple, s√©curis√©e et adapt√©e aux besoins d'une communaut√© mobile-first. Rejoignez-nous et d√©couvrez comment votre engagement peut vous permettre de progresser.
              </p>
            </div>
          </div>
        </div>
      `,

      pending: () => `
        <div class="min-h-screen p-4 bg-gray-100">
          <div class="card max-w-lg mx-auto">
            <div class="text-center mb-6">
              <div class="text-6xl mb-4">‚è≥</div>
              <h1 class="text-xl font-bold text-orange-600">Compte de recharge - Compte inactif</h1>
              <p class="text-gray-600 mt-2">Veuillez vous abonner. Utilisez le num√©ro <strong>${state.currentUser?.phone || ''}</strong> pour le d√©p√¥t.</p>
            </div>
            
            <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg mb-4">
              <p class="font-bold text-orange-800 text-center text-lg">${state.config.subscriptionAmount || 4000} FCFA</p>
            </div>

            <div class="mb-6">
              <h3 class="font-bold mb-3">üì± Num√©ros de paiement :</h3>
              <div class="space-y-2">
                ${(state.config.paymentNumbers || []).map(p => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">${p.operator}</p>
                      <p class="text-sm text-gray-500">${p.name}</p>
                    </div>
                    <div class="text-right">
                      <p class="font-mono font-bold text-blue-600">${p.number}</p>
                      <button onclick="copyNumber('${p.number}')" class="text-xs text-blue-500">üìã Copier</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 class="font-bold text-blue-600 mb-2">üìù Apr√®s votre paiement :</h3>
              <p class="text-sm text-gray-700">Envoyez une capture d'√©cran de la confirmation de paiement pour activer votre compte.</p>
            </div>

            <button onclick="openPaymentProof()" class="btn-orange w-full mb-3">üì§ Envoyer ma preuve de paiement</button>
            
            ${state.currentUser?.status === 'pending_payment' ? `
              <div class="bg-green-50 border border-green-200 p-3 rounded-lg text-center mb-3">
                <p class="text-green-700 text-sm">‚úì Preuve envoy√©e - En attente de validation</p>
              </div>
            ` : ''}
            
            <button onclick="logout()" class="w-full text-red-500 py-2">D√©connexion</button>
          </div>
        </div>
      `,

      dashboard: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-1">Bonjour, ${state.currentUser?.name?.split(' ')[0]} üëã</h1>
            <p class="text-sm slogan mb-4">"Partagez, Gagnez, Grandissez ensemble"</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="stat-blue rounded-xl p-4 text-center">
                <p class="text-sm opacity-80">Solde Mis</p>
                <p class="text-2xl font-bold">4 000 FCFA</p>
              </div>
              <div class="stat-orange rounded-xl p-4 text-center">
                <p class="text-sm opacity-80">Gains Accumul√©s</p>
                <p class="text-2xl font-bold">${state.currentUser?.earnings || 0} FCFA</p>
              </div>
            </div>

            <div class="card mb-4">
              <h2 class="font-bold mb-3">üìä Vos statistiques</h2>
              <div class="grid grid-cols-4 gap-2 text-center">
                <div class="bg-blue-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-blue-600">${state.referrals?.level1?.users?.length || 0}</p>
                  <p class="text-xs text-gray-500">Filleuls N1</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-green-600">${state.referrals?.level2?.users?.length || 0}</p>
                  <p class="text-xs text-gray-500">Filleuls N2</p>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-purple-600">${state.currentUser?.completedTasks?.length || 0}</p>
                  <p class="text-xs text-gray-500">T√¢ches</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                  <p class="text-xl font-bold text-orange-600">${state.currentUser?.watchedVideos?.length || 0}</p>
                  <p class="text-xs text-gray-500">Vid√©os</p>
                </div>
              </div>
            </div>

            <div class="card mb-4 bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300">
              <h2 class="font-bold mb-2 text-orange-700">üî• Invitez vos amis!</h2>
              <p class="text-sm text-gray-700 mb-3">Plus vous partagez, plus vous gagnez. Chaque ami valid√© = des commissions automatiques!</p>
              <div class="bg-white p-3 rounded-lg">
                <p class="text-xs text-gray-500 mb-1">Votre code :</p>
                <div class="flex items-center justify-between">
                  <code class="text-lg font-bold text-blue-600">${state.currentUser?.referralCode}</code>
                  <button onclick="copyReferral()" class="btn-orange text-sm py-2 px-4">üìã Copier le lien</button>
                </div>
              </div>
            </div>

            <div class="card">
              <h2 class="font-bold mb-3">üí° Actions rapides</h2>
              <div class="grid grid-cols-4 gap-3">
                <button onclick="navigate('tasks')" class="bg-green-100 text-green-700 p-4 rounded-lg text-center hover:bg-green-200 transition">
                  <p class="text-2xl mb-1">üìã</p>
                  <p class="font-semibold text-xs">T√¢ches</p>
                </button>
                <button onclick="navigate('videos')" class="bg-purple-100 text-purple-700 p-4 rounded-lg text-center hover:bg-purple-200 transition">
                  <p class="text-2xl mb-1">üé¨</p>
                  <p class="font-semibold text-xs">Vid√©os</p>
                </button>
                <button onclick="navigate('referrals')" class="bg-blue-100 text-blue-700 p-4 rounded-lg text-center hover:bg-blue-200 transition">
                  <p class="text-2xl mb-1">üë•</p>
                  <p class="font-semibold text-xs">Parrainer</p>
                </button>
                <button onclick="navigate('withdraw')" class="bg-orange-100 text-orange-700 p-4 rounded-lg text-center hover:bg-orange-200 transition">
                  <p class="text-2xl mb-1">üí∞</p>
                  <p class="font-semibold text-xs">Retrait</p>
                </button>
              </div>
            </div>
          </div>
        </div>
      `,

      tasks: () => {
        const completedToday = state.currentUser?.tasksCompletedToday?.length || 0;
        const availableTasks = state.tasks.filter(t => !state.currentUser?.completedTasks?.includes(getId(t)));
        
        return `
          <div class="min-h-screen bg-gray-100">
            ${renderNav()}
            <div class="p-4 max-w-4xl mx-auto">
              <h1 class="text-xl font-bold mb-2">üìã Micro-T√¢ches</h1>
              <p class="text-sm text-gray-500 mb-4">Compl√©tez des t√¢ches et gagnez de l'argent r√©el!</p>
              
              <div class="bg-white rounded-lg p-4 mb-4 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Aujourd'hui</span>
                  <span class="text-blue-600 font-bold">${completedToday}/10 t√¢ches</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${completedToday * 10}%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">${10 - completedToday} t√¢ches restantes aujourd'hui</p>
              </div>
              
              ${availableTasks.length === 0 ? `
                <div class="card text-center py-8">
                  <p class="text-4xl mb-3">üéâ</p>
                  <p class="font-bold text-green-600">Toutes les t√¢ches sont compl√©t√©es!</p>
                  <p class="text-gray-500 text-sm">Revenez plus tard pour de nouvelles t√¢ches.</p>
                </div>
              ` : `
                <div class="space-y-3">
                  ${availableTasks.map(task => `
                    <div class="card hover:shadow-lg transition">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <span class="text-xs px-2 py-1 rounded-full ${getTaskTypeColor(task.type)}">${getTaskTypeLabel(task.type)}</span>
                          <h3 class="font-semibold mt-2">${task.title}</h3>
                          <p class="text-sm text-gray-500 mt-1">${task.description}</p>
                        </div>
                        <div class="text-right ml-4">
                          <p class="font-bold text-green-600 text-lg">+${task.reward} FCFA</p>
                        </div>
                      </div>
                      <button onclick="openTask('${getId(task)}')" class="btn-success w-full mt-4 text-sm py-3">
                        Commencer cette t√¢che
                      </button>
                    </div>
                  `).join('')}
                </div>
              `}
              
              <div class="mt-6">
                <h3 class="font-bold mb-3 text-gray-600">‚úì T√¢ches compl√©t√©es (${state.currentUser?.completedTasks?.length || 0})</h3>
                <div class="space-y-2">
                  ${state.tasks.filter(t => state.currentUser?.completedTasks?.includes(getId(t))).map(task => `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                      <div>
                        <p class="font-semibold text-green-700">${task.title}</p>
                        <p class="text-xs text-green-600">+${task.reward} FCFA gagn√©s</p>
                      </div>
                      <span class="text-green-500 text-xl">‚úì</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      },

      videos: () => {
        const watchedVideos = state.currentUser?.watchedVideos || [];
        const availableVideos = state.videos.filter(v => !watchedVideos.includes(getId(v)));
        
        return `
          <div class="min-h-screen bg-gray-100">
            ${renderNav()}
            <div class="p-4 max-w-4xl mx-auto">
              <h1 class="text-xl font-bold mb-2">üé¨ Vid√©os √† regarder</h1>
              <p class="text-sm text-gray-500 mb-4">Regardez des vid√©os et gagnez de l'argent!</p>
              
              <div class="bg-purple-50 border border-purple-200 p-3 rounded-lg mb-4">
                <p class="text-sm text-purple-800">
                  <strong>üí° Conseil :</strong> Regardez la vid√©o jusqu'√† la fin pour valider vos gains!
                </p>
              </div>
              
              ${availableVideos.length === 0 ? `
                <div class="card text-center py-8">
                  <p class="text-4xl mb-3">üéâ</p>
                  <p class="font-bold text-green-600">Toutes les vid√©os ont √©t√© regard√©es!</p>
                  <p class="text-gray-500 text-sm">De nouvelles vid√©os seront bient√¥t disponibles.</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${availableVideos.map(video => `
                    <div class="video-card">
                      <div class="p-4">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-xs px-2 py-1 rounded-full ${video.platform === 'youtube' ? 'bg-red-100 text-red-600' : 'bg-pink-100 text-pink-600'}">
                            ${video.platform === 'youtube' ? '‚ñ∂Ô∏è YouTube' : 'üéµ TikTok'}
                          </span>
                          <span class="text-xs text-gray-500">${video.duration} min</span>
                        </div>
                        <h3 class="font-semibold">${video.title}</h3>
                        <div class="flex justify-between items-center mt-3">
                          <p class="font-bold text-green-600">+${video.reward} FCFA</p>
                          <button onclick="openVideo('${getId(video)}')" class="btn-primary text-sm py-2 px-4">
                            Regarder & Gagner
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
              
              <div class="mt-6">
                <h3 class="font-bold mb-3 text-gray-600">‚úì Vid√©os regard√©es (${watchedVideos.length})</h3>
                <div class="space-y-2">
                  ${state.videos.filter(v => watchedVideos.includes(getId(v))).map(video => `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                      <div>
                        <p class="font-semibold text-green-700">${video.title}</p>
                        <p class="text-xs text-green-600">+${video.reward} FCFA gagn√©s</p>
                      </div>
                      <span class="text-green-500 text-xl">‚úì</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      },

      referrals: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-2">üë• Programme Parrainage</h1>
            <p class="slogan text-sm mb-4">"Partagez, Gagnez, Grandissez ensemble"</p>
            
            <div class="card mb-4">
              <h2 class="font-bold mb-3">üîó Votre lien de parrainage</h2>
              <div class="bg-gradient-to-r from-orange-500 to-pink-500 p-4 rounded-lg text-white text-center">
                <p class="text-sm opacity-80 mb-1">Votre code unique</p>
                <p class="text-2xl font-bold mb-3">${state.currentUser?.referralCode}</p>
                <button onclick="copyReferral()" class="bg-white text-orange-600 px-6 py-2 rounded-full font-semibold text-sm">
                  üìã Copier le lien complet
                </button>
              </div>
            </div>

            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-orange-300 p-4 rounded-lg mb-4">
              <p class="text-sm text-orange-800">
                <strong>üî• Partagez votre lien sur WhatsApp, Facebook, TikTok!</strong><br>
                Plus vous invitez d'amis, plus vous gagnez. Ensemble, on va plus loin!
              </p>
            </div>

            <div class="grid gap-4">
              <div class="card border-l-4 border-green-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-green-600">ü•á Niveau 1 (Filleuls directs)</h3>
                    <p class="text-sm text-gray-500">2 000 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-3xl font-bold">${state.referrals?.level1?.users?.length || 0}</p>
                    <p class="text-green-600 font-bold">${state.referrals?.level1?.total || 0} FCFA</p>
                  </div>
                </div>
                ${(state.referrals?.level1?.users?.length > 0) ? `
                  <div class="mt-3 pt-3 border-t">
                    <div class="flex flex-wrap gap-2">
                      ${state.referrals.level1.users.map(u => `
                        <span class="text-xs px-2 py-1 rounded-full ${u.status === 'validated' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                          ${u.name} ${u.status === 'validated' ? '‚úì' : '‚è≥'}
                        </span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>

              <div class="card border-l-4 border-blue-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-blue-600">ü•à Niveau 2</h3>
                    <p class="text-sm text-gray-500">800 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-3xl font-bold">${state.referrals?.level2?.users?.length || 0}</p>
                    <p class="text-blue-600 font-bold">${state.referrals?.level2?.total || 0} FCFA</p>
                  </div>
                </div>
              </div>

              <div class="card border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-purple-600">ü•â Niveau 3</h3>
                    <p class="text-sm text-gray-500">400 FCFA par filleul valid√©</p>
                  </div>
                  <div class="text-right">
                    <p class="text-3xl font-bold">${state.referrals?.level3?.users?.length || 0}</p>
                    <p class="text-purple-600 font-bold">${state.referrals?.level3?.total || 0} FCFA</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mt-4 stat-orange">
              <div class="text-center">
                <p class="text-sm opacity-80">Total des gains parrainage</p>
                <p class="text-3xl font-bold">
                  ${(state.referrals?.level1?.total || 0) + (state.referrals?.level2?.total || 0) + (state.referrals?.level3?.total || 0)} FCFA
                </p>
              </div>
            </div>
          </div>
        </div>
      `,

      withdraw: () => `
        <div class="min-h-screen bg-gray-100">
          ${renderNav()}
          <div class="p-4 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold mb-4">üí∞ Retraits</h1>
            
            <div class="card mb-4">
              <div class="stat-orange rounded-lg p-4 text-center mb-4">
                <p class="text-sm opacity-80">Solde disponible</p>
                <p class="text-3xl font-bold">${state.currentUser?.earnings || 0} FCFA</p>
              </div>

                <form id="withdrawForm">
                  <label class="block text-sm font-medium text-gray-700 mb-2">M√©thode de retrait</label>
                  <select id="withdrawMethod" class="input">
                    <option value="moov">Moov Money (min 15 000 FCFA)</option>
                    <option value="mix">Mix by Yas (min 15 000 FCFA)</option>
                  </select>
                  
                  <label class="block text-sm font-medium text-gray-700 mb-2">Montant √† retirer</label>
                  <input type="number" id="withdrawAmount" class="input" placeholder="Montant en FCFA (min 15 000)" min="15000" required>
                  
                  <label class="block text-sm font-medium text-gray-700 mb-2">Num√©ro de r√©ception</label>
                  <input type="text" id="withdrawAccount" class="input" placeholder="+225 XX XX XX XX XX" required>
                  
                  <label class="block text-sm font-medium text-gray-700 mb-2">Nom du titulaire</label>
                  <input type="text" id="withdrawName" class="input" placeholder="Nom complet du compte" value="${state.currentUser?.name || ''}">
                  
                  <button type="submit" class="btn-orange w-full">Demander le retrait</button>
                </form>
                
                <p class="text-xs text-gray-500 text-center mt-3">‚è±Ô∏è Traitement sous 24-48h ouvr√©es</p>
            </div>

            <div class="card">
              <h2 class="font-bold mb-3">üìú Historique des retraits</h2>
              ${state.withdrawals.length === 0 ? 
                '<p class="text-gray-500 text-sm text-center py-4">Aucun retrait effectu√©</p>' : `
                <div class="space-y-2">
                  ${state.withdrawals.map(w => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <div>
                        <p class="font-semibold">${w.amount} FCFA</p>
                        <p class="text-xs text-gray-500">${w.method === 'moov' ? 'Moov Money' : 'Mix by Yas'} ‚Ä¢ ${new Date(w.createdAt).toLocaleDateString('fr-FR')}</p>
                      </div>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(w.status)}">${getStatusLabel(w.status)}</span>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `,

      admin: () => `
        <div class="min-h-screen bg-gray-100">
          <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
              <h1 class="text-xl font-bold">‚öôÔ∏è Admin Panel</h1>
              <button onclick="logout()" class="bg-white/20 px-4 py-2 rounded-lg text-sm">D√©connexion</button>
            </div>
          </div>
          
          <div class="p-4 max-w-4xl mx-auto">
            <div class="flex gap-2 overflow-x-auto mb-4 pb-2">
              <button onclick="setAdminTab('stats')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-stats">üìä Stats</button>
              <button onclick="setAdminTab('pending')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-pending">‚è≥ En attente</button>
              <button onclick="setAdminTab('users')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-users">üë• Utilisateurs</button>
              <button onclick="setAdminTab('withdrawals')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-withdrawals">üí∏ Retraits</button>
              <button onclick="setAdminTab('videos')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-videos">üé¨ Vid√©os</button>
              <button onclick="setAdminTab('config')" class="admin-tab px-4 py-2 bg-white rounded-lg text-sm whitespace-nowrap" id="tab-config">‚öôÔ∏è Config</button>
            </div>
            
            <div id="adminContent"></div>
          </div>
        </div>
      `
    };

    // Navigation
    function renderNav() {
      return `
        <div class="bg-white shadow-sm sticky top-0 z-50">
          <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <h1 class="text-lg font-bold text-blue-600">üöÄ Motosu</h1>
            <div class="flex items-center gap-3">
              <span class="text-sm font-bold text-orange-600">${state.currentUser?.earnings || 0} FCFA</span>
              <button onclick="logout()" class="text-red-500 text-sm">Quitter</button>
            </div>
          </div>
          <div class="flex border-t">
            <button onclick="navigate('dashboard')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'dashboard' ? 'tab-active' : 'text-gray-500'}">üè† Accueil</button>
            <button onclick="navigate('tasks')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'tasks' ? 'tab-active' : 'text-gray-500'}">üìã T√¢ches</button>
            <button onclick="navigate('videos')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'videos' ? 'tab-active' : 'text-gray-500'}">üé¨ Vid√©os</button>
            <button onclick="navigate('referrals')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'referrals' ? 'tab-active' : 'text-gray-500'}">üë• Parrainage</button>
            <button onclick="navigate('withdraw')" class="flex-1 py-3 text-xs text-center ${state.currentPage === 'withdraw' ? 'tab-active' : 'text-gray-500'}">üí∞ Retrait</button>
          </div>
        </div>
      `;
    }

    function getTaskTypeColor(type) {
      const colors = {
        sondage: 'bg-blue-100 text-blue-600',
        verification: 'bg-yellow-100 text-yellow-600',
        classification: 'bg-purple-100 text-purple-600',
        transcription: 'bg-green-100 text-green-600'
      };
      return colors[type] || 'bg-gray-100 text-gray-600';
    }

    function getTaskTypeLabel(type) {
      const labels = {
        sondage: 'üìä Sondage',
        verification: '‚úÖ V√©rification',
        classification: 'üìÅ Classification',
        transcription: '‚úçÔ∏è Transcription'
      };
      return labels[type] || type;
    }

    function getStatusColor(status) {
      const colors = {
        pending: 'bg-yellow-100 text-yellow-700',
        pending_payment: 'bg-orange-100 text-orange-700',
        approved: 'bg-green-100 text-green-700',
        rejected: 'bg-red-100 text-red-700',
        validated: 'bg-green-100 text-green-700'
      };
      return colors[status] || 'bg-gray-100 text-gray-600';
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'En attente',
        pending_payment: 'Paiement √† v√©rifier',
        approved: 'Approuv√©',
        rejected: 'Refus√©',
        validated: 'Valid√©'
      };
      return labels[status] || status;
    }

    async function navigate(page) {
      state.currentPage = page;
      const userId = getId(state.currentUser);
      
      if (state.currentUser && state.currentUser.status === 'validated') {
        if (['dashboard', 'referrals', 'withdraw'].includes(page)) {
          state.referrals = await api(`/api/referrals/${userId}`);
        }
        if (page === 'tasks') {
          const tasksData = await api('/api/tasks');
          state.tasks = Array.isArray(tasksData) ? tasksData : [];
        }
        if (page === 'videos') {
          const videosData = await api('/api/videos');
          state.videos = Array.isArray(videosData) ? videosData : [];
        }
        if (page === 'withdraw') {
          state.withdrawals = await api(`/api/withdrawals/user/${userId}`);
        }
      }
      
      render();
    }

    function render() {
      const app = $('#app');
      if (pages[state.currentPage]) {
        app.innerHTML = pages[state.currentPage]();
        attachEventListeners();
      }
    }

    function attachEventListeners() {
      const loginForm = $('#loginForm');
      if (loginForm) {
        loginForm.onsubmit = async (e) => {
          e.preventDefault();
          const res = await api('/api/login', 'POST', {
            email: $('#loginEmail').value,
            password: $('#loginPassword').value
          });
          if (res.error) {
            toast(res.error, 'error');
          } else {
            state.currentUser = res.user;
            localStorage.setItem('userId', getId(res.user));
            if (res.token) localStorage.setItem('authToken', res.token);
            if (res.user.isAdmin) {
              navigate('admin');
            } else if (res.user.status === 'validated') {
              navigate('dashboard');
            } else {
              navigate('pending');
            }
            toast('Connexion r√©ussie!', 'success');
          }
        };
      }

      const registerForm = $('#registerForm');
      if (registerForm) {
        registerForm.onsubmit = async (e) => {
          e.preventDefault();
          const res = await api('/api/register', 'POST', {
            name: $('#regName').value,
            email: $('#regEmail').value,
            phone: $('#regPhone').value,
            password: $('#regPassword').value,
            referralCode: $('#regReferral').value
          });
          if (res.error) {
            toast(res.error, 'error');
          } else {
            state.currentUser = res.user;
            localStorage.setItem('userId', getId(res.user));
            if (res.token) localStorage.setItem('authToken', res.token);
            localStorage.removeItem('referralCode');
            navigate('pending');
            toast('Inscription r√©ussie! Veuillez activer votre compte.', 'success');
          }
        };
      }

      const withdrawForm = $('#withdrawForm');
      if (withdrawForm) {
        withdrawForm.onsubmit = async (e) => {
          e.preventDefault();
          const method = $('#withdrawMethod').value;
          const amount = parseInt($('#withdrawAmount').value);
          
          const res = await api('/api/withdraw', 'POST', {
            userId: getId(state.currentUser),
            amount,
            method,
            accountNumber: $('#withdrawAccount').value,
            accountName: $('#withdrawName').value
          });
          
          if (res.error) {
            toast(res.error, 'error');
            if (res.needMoreReferrals) {
              navigate('referrals');
            }
          } else {
            toast(res.message, 'success');
            state.currentUser = await api(`/api/user/${getId(state.currentUser)}`);
            navigate('withdraw');
          }
        };
      }
      
      if (state.currentPage === 'admin') {
        setAdminTab('stats');
      }
    }

    // Vid√©os
    function openVideo(videoId) {
      const video = state.videos.find(v => getId(v) === videoId);
      if (!video) return;
      
      state.currentVideo = video;
      const requiredTime = Math.ceil(video.duration * 60 * 0.8);
      
      // Construire l'URL d'embed correcte
      let embedUrl = video.url;
      
      if (video.platform === 'youtube') {
        // Extraire l'ID YouTube de diff√©rents formats d'URL
        let videoIdYT = '';
        if (video.url.includes('youtube.com/watch')) {
          const urlParams = new URLSearchParams(video.url.split('?')[1]);
          videoIdYT = urlParams.get('v');
        } else if (video.url.includes('youtu.be/')) {
          videoIdYT = video.url.split('youtu.be/')[1].split('?')[0];
        } else if (video.url.includes('youtube.com/embed/')) {
          videoIdYT = video.url.split('embed/')[1].split('?')[0];
        } else if (video.videoId) {
          videoIdYT = video.videoId;
        }
        if (videoIdYT) {
          embedUrl = `https://www.youtube.com/embed/${videoIdYT}?autoplay=1&rel=0`;
        }
      } else if (video.platform === 'tiktok') {
        // Pour TikTok, extraire l'ID vid√©o
        let tiktokId = '';
        const tiktokMatch = video.url.match(/video\/(\d+)/);
        if (tiktokMatch) {
          tiktokId = tiktokMatch[1];
        } else if (video.videoId) {
          tiktokId = video.videoId;
        }
        if (tiktokId) {
          embedUrl = `https://www.tiktok.com/embed/v2/${tiktokId}`;
        }
      }
      
      const modal = $('#modal');
      modal.innerHTML = `
        <div class="modal" onclick="closeModal(event)">
          <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="flex justify-between items-start mb-4">
              <div>
                <span class="text-xs px-2 py-1 rounded-full ${video.platform === 'youtube' ? 'bg-red-100 text-red-600' : 'bg-pink-100 text-pink-600'}">
                  ${video.platform === 'youtube' ? '‚ñ∂Ô∏è YouTube' : 'üéµ TikTok'}
                </span>
                <h2 class="text-lg font-bold mt-2">${video.title}</h2>
              </div>
              <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="video-container mb-4" style="background: #000; border-radius: 12px; overflow: hidden;">
              <iframe 
                src="${embedUrl}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                allowfullscreen
                style="width: 100%; height: 100%; min-height: 280px;"
                referrerpolicy="strict-origin-when-cross-origin">
              </iframe>
            </div>
            
            <div class="bg-purple-50 p-3 rounded-lg mb-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-purple-800">‚è±Ô∏è Temps de visionnage</span>
                <span id="watchTimer" class="font-bold text-purple-600">0:00</span>
              </div>
              <div class="progress-bar">
                <div id="watchProgress" class="progress-fill bg-purple-500" style="width: 0%"></div>
              </div>
              <p class="text-xs text-purple-600 mt-1">Regardez au moins ${Math.floor(requiredTime/60)}:${(requiredTime%60).toString().padStart(2,'0')} pour valider</p>
            </div>
            
            <div class="flex gap-3">
              <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Annuler</button>
              <button id="validateVideoBtn" onclick="validateVideo('${videoId}')" class="flex-1 btn-success py-3 opacity-50" disabled>
                Valider (+${video.reward} FCFA)
              </button>
            </div>
          </div>
        </div>
      `;
      
      let watchTime = 0;
      
      window.videoTimer = setInterval(() => {
        watchTime++;
        const minutes = Math.floor(watchTime / 60);
        const seconds = watchTime % 60;
        const timerEl = $('#watchTimer');
        const progressEl = $('#watchProgress');
        const btnEl = $('#validateVideoBtn');
        
        if (timerEl) {
          timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          progressEl.style.width = `${Math.min(100, (watchTime / requiredTime) * 100)}%`;
          
          if (watchTime >= requiredTime) {
            btnEl.disabled = false;
            btnEl.classList.remove('opacity-50');
          }
        }
      }, 1000);
    }

    async function validateVideo(videoId) {
      clearInterval(window.videoTimer);
      const video = state.videos.find(v => getId(v) === videoId);
      
      const res = await api(`/api/videos/${videoId}/watch`, 'POST', {
        userId: getId(state.currentUser),
        watchTime: video.duration * 60
      });
      
      if (res.error) {
        toast(res.error, 'error');
      } else {
        toast(res.message, 'success');
        closeModal();
        state.currentUser = await api(`/api/user/${getId(state.currentUser)}`);
        navigate('videos');
      }
    }

    // T√¢ches
    function openTask(taskId) {
      const task = state.tasks.find(t => getId(t) === taskId);
      if (!task) return;
      
      state.currentTask = task;
      state.surveyAnswers = {};
      
      const modal = $('#modal');
      modal.innerHTML = renderTaskModal(task);
    }

    function renderTaskModal(task) {
      let content = '';
      const taskId = getId(task);
      
      if (task.type === 'sondage') {
        content = `
          <div id="surveyContainer">
            ${task.content.questions.map((q, i) => `
              <div class="question-container" id="question-${i}">
                <p class="question-title">${i + 1}. ${q.question}</p>
                <div class="space-y-2">
                  ${q.options.map((opt, j) => `
                    <button type="button" 
                      class="option-btn" 
                      data-question="${i}" 
                      data-option="${j}"
                      onclick="selectOption(${i}, ${j}, '${opt.replace(/'/g, "\\'")}')">
                      ${opt}
                    </button>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
          <div id="surveyProgress" class="mt-4 p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800">R√©ponses: <span id="answeredCount">0</span>/${task.content.questions.length}</p>
          </div>
        `;
      } else if (task.type === 'verification') {
        content = `
          <div class="mb-4 p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800">${task.content.instruction}</p>
          </div>
          <div class="space-y-2" id="verificationItems">
            ${task.content.items.map((item, i) => `
              <div class="check-item" data-index="${i}" onclick="toggleCheck(this, ${i})">
                <span class="flex-1">${item.text}</span>
                <span class="checkmark text-xl ml-2" style="display:none">‚úì</span>
              </div>
            `).join('')}
          </div>
        `;
      } else if (task.type === 'classification') {
        content = `
          <div class="mb-4 p-3 bg-purple-50 rounded-lg">
            <p class="text-sm text-purple-800">${task.content.instruction}</p>
          </div>
          <div class="space-y-3" id="classificationItems">
            ${task.content.items.map((item, i) => `
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg gap-3">
                <span class="font-medium flex-1 text-sm">${item.name}</span>
                <select class="category-select" data-index="${i}" onchange="updateClassification(${i}, this.value)">
                  <option value="">Choisir...</option>
                  ${task.content.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
              </div>
            `).join('')}
          </div>
        `;
      } else if (task.type === 'transcription') {
        content = `
          <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
            <p class="text-sm text-gray-500 mb-2">üìÑ Texte √† recopier exactement :</p>
            <p class="text-gray-800 italic leading-relaxed">"${task.content.textToTranscribe}"</p>
          </div>
          <textarea id="transcriptionText" class="input h-32" placeholder="Recopiez le texte ci-dessus exactement..."></textarea>
          <p class="text-xs text-gray-500">Pr√©cision minimum requise : ${task.content.minAccuracy}%</p>
        `;
      }

      return `
        <div class="modal" onclick="closeModal(event)">
          <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
              <div>
                <span class="text-xs px-2 py-1 rounded-full ${getTaskTypeColor(task.type)}">${getTaskTypeLabel(task.type)}</span>
                <h2 class="text-lg font-bold mt-2">${task.title}</h2>
                <p class="text-sm text-gray-500">${task.description}</p>
              </div>
              <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6 max-h-80 overflow-y-auto">
              ${content}
            </div>
            
            <div class="flex gap-3 sticky bottom-0 bg-white pt-3 border-t">
              <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Annuler</button>
              <button onclick="submitTask('${taskId}')" class="flex-1 btn-success py-3">Valider (+${task.reward} FCFA)</button>
            </div>
          </div>
        </div>
      `;
    }

    // S√©lectionner une option de sondage
    function selectOption(questionIndex, optionIndex, value) {
      // D√©s√©lectionner toutes les options de cette question
      $$(`[data-question="${questionIndex}"]`).forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // S√©lectionner l'option cliqu√©e
      const btn = $(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`);
      if (btn) {
        btn.classList.add('selected');
      }
      
      // Sauvegarder la r√©ponse
      state.surveyAnswers[questionIndex] = value;
      
      // Mettre √† jour le compteur
      const countEl = $('#answeredCount');
      if (countEl) {
        countEl.textContent = Object.keys(state.surveyAnswers).length;
      }
    }

    // Toggle v√©rification
    function toggleCheck(element, index) {
      element.classList.toggle('selected');
      const checkmark = element.querySelector('.checkmark');
      if (element.classList.contains('selected')) {
        checkmark.style.display = 'block';
      } else {
        checkmark.style.display = 'none';
      }
    }

    // Mettre √† jour classification
    function updateClassification(index, value) {
      state.surveyAnswers[index] = value;
    }

    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      if (window.videoTimer) clearInterval(window.videoTimer);
      $('#modal').innerHTML = '';
      state.currentTask = null;
      state.currentVideo = null;
      state.surveyAnswers = {};
    }

    async function submitTask(taskId) {
      const task = state.currentTask;
      if (!task) return;
      
      let answers;
      
      if (task.type === 'sondage') {
        answers = state.surveyAnswers;
        
        // V√©rifier que toutes les questions ont une r√©ponse
        const answeredCount = Object.keys(answers).length;
        if (answeredCount < task.content.questions.length) {
          toast(`Veuillez r√©pondre √† toutes les questions (${answeredCount}/${task.content.questions.length})`, 'error');
          return;
        }
      } else if (task.type === 'verification') {
        answers = [];
        $$('.check-item.selected').forEach(item => {
          answers.push(parseInt(item.dataset.index));
        });
        
        if (answers.length === 0) {
          toast('Veuillez s√©lectionner au moins un √©l√©ment', 'error');
          return;
        }
      } else if (task.type === 'classification') {
        answers = {};
        let allFilled = true;
        $$('.category-select').forEach(sel => {
          if (!sel.value) allFilled = false;
          answers[sel.dataset.index] = sel.value;
        });
        
        if (!allFilled) {
          toast('Veuillez classifier tous les √©l√©ments', 'error');
          return;
        }
      } else if (task.type === 'transcription') {
        answers = $('#transcriptionText').value;
        if (!answers || answers.trim().length < 10) {
          toast('Veuillez saisir la transcription compl√®te', 'error');
          return;
        }
      }
      
      const res = await api(`/api/tasks/${taskId}/complete`, 'POST', {
        userId: getId(state.currentUser),
        answers
      });
      
      if (res.error) {
        toast(res.error, 'error');
      } else {
        toast(res.message, 'success');
        closeModal();
        state.currentUser = await api(`/api/user/${getId(state.currentUser)}`);
        navigate('tasks');
      }
    }

    // Preuve de paiement
    function openPaymentProof() {
      const modal = $('#modal');
      modal.innerHTML = `
        <div class="modal" onclick="closeModal(event)">
          <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-lg font-bold mb-4">üì§ Envoyer la preuve de paiement</h2>
            
            <form id="paymentProofForm">
              <label class="block text-sm font-medium text-gray-700 mb-2">Capture d'√©cran du paiement *</label>
              <input type="file" id="proofScreenshot" accept="image/*" class="input" required>
              <div id="imagePreview" class="mb-3 hidden">
                <p class="text-xs text-gray-500 mb-1">Aper√ßu :</p>
                <img id="previewImg" class="max-w-full max-h-40 rounded-lg border">
              </div>
              
              <label class="block text-sm font-medium text-gray-700 mb-2">ID Transaction (optionnel)</label>
              <input type="text" id="proofTransactionId" class="input" placeholder="Ex: TXN123456789">
              
              <label class="block text-sm font-medium text-gray-700 mb-2">Num√©ro utilis√© pour le paiement</label>
              <input type="text" id="proofPhone" class="input" value="${state.currentUser?.phone || ''}" placeholder="+225 XX XX XX XX XX">
              
              <div class="flex gap-3 mt-4">
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Annuler</button>
                <button type="submit" id="submitProofBtn" class="flex-1 btn-orange py-3">Envoyer</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      // Pr√©visualisation de l'image
      $('#proofScreenshot').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            $('#previewImg').src = ev.target.result;
            $('#imagePreview').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      };
      
      $('#paymentProofForm').onsubmit = async (e) => {
        e.preventDefault();
        const file = $('#proofScreenshot').files[0];
        if (!file) {
          toast('Veuillez ajouter une capture d\'√©cran', 'error');
          return;
        }
        
        // D√©sactiver le bouton pendant l'envoi
        const btn = $('#submitProofBtn');
        btn.disabled = true;
        btn.textContent = 'Envoi en cours...';
        
        const reader = new FileReader();
        reader.onload = async () => {
          const base64Image = reader.result;
          console.log('Image convertie en base64, taille:', base64Image.length);
          
          const res = await api('/api/payment/proof', 'POST', {
            userId: getId(state.currentUser),
            screenshot: base64Image,
            transactionId: $('#proofTransactionId').value,
            phoneUsed: $('#proofPhone').value
          });
          
          if (res.error) {
            toast(res.error, 'error');
            btn.disabled = false;
            btn.textContent = 'Envoyer';
          } else {
            toast(res.message, 'success');
            closeModal();
            state.currentUser = await api(`/api/user/${getId(state.currentUser)}`);
            navigate('pending');
          }
        };
        reader.onerror = () => {
          toast('Erreur lors de la lecture de l\'image', 'error');
          btn.disabled = false;
          btn.textContent = 'Envoyer';
        };
        reader.readAsDataURL(file);
      };
    }

    function copyNumber(number) {
      navigator.clipboard.writeText(number);
      toast('Num√©ro copi√©: ' + number, 'success');
    }

    function copyReferral() {
      const link = `${window.location.origin}?ref=${state.currentUser.referralCode}`;
      navigator.clipboard.writeText(link);
      toast('Lien de parrainage copi√©! Partagez-le!', 'success');
    }

    function logout() {
      state.currentUser = null;
      localStorage.removeItem('userId');
      localStorage.removeItem('authToken');
      navigate('login');
      toast('D√©connexion r√©ussie', 'info');
    }

    // Admin
    let currentAdminTab = 'stats';

    async function setAdminTab(tab) {
      currentAdminTab = tab;
      $$('.admin-tab').forEach(el => el.classList.remove('bg-blue-600', 'text-white'));
      $(`#tab-${tab}`)?.classList.add('bg-blue-600', 'text-white');
      
      const content = $('#adminContent');
      if (!content) return;
      
      if (tab === 'stats') {
        state.adminData.stats = await api('/api/admin/stats');
        content.innerHTML = renderAdminStats();
      } else if (tab === 'pending') {
        state.adminData.pending = await api('/api/admin/pending');
        content.innerHTML = renderAdminPending();
      } else if (tab === 'users') {
        state.adminData.users = await api('/api/admin/users');
        content.innerHTML = renderAdminUsers();
      } else if (tab === 'withdrawals') {
        state.adminData.withdrawals = await api('/api/admin/withdrawals');
        content.innerHTML = renderAdminWithdrawals();
      } else if (tab === 'videos') {
        state.adminData.videos = await api('/api/admin/videos');
        content.innerHTML = renderAdminVideos();
      } else if (tab === 'config') {
        state.adminData.config = await api('/api/admin/config');
        content.innerHTML = renderAdminConfig();
      }
    }

    function renderAdminStats() {
      const s = state.adminData.stats;
      return `
        <div class="grid grid-cols-2 gap-4">
          <div class="card text-center">
            <p class="text-3xl font-bold text-blue-600">${s.totalUsers || 0}</p>
            <p class="text-gray-500 text-sm">Total utilisateurs</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-green-600">${s.validatedUsers || 0}</p>
            <p class="text-gray-500 text-sm">Comptes actifs</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-yellow-600">${s.pendingUsers || 0}</p>
            <p class="text-gray-500 text-sm">En attente</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-purple-600">${s.pendingWithdrawals || 0}</p>
            <p class="text-gray-500 text-sm">Retraits en attente</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-pink-600">${s.videosCount || 0}</p>
            <p class="text-gray-500 text-sm">Vid√©os</p>
          </div>
          <div class="card text-center">
            <p class="text-3xl font-bold text-orange-600">${s.totalWithdrawals || 0} FCFA</p>
            <p class="text-gray-500 text-sm">Total retraits</p>
          </div>
        </div>
      `;
    }

    function renderAdminPending() {
      if (state.adminData.pending.length === 0) {
        return '<div class="card text-center text-gray-500 py-8">‚úì Aucun compte en attente</div>';
      }
      return state.adminData.pending.map(u => {
        const hasProof = u.paymentProof && u.paymentProof.screenshot;
        return `
        <div class="card mb-3">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
            <div class="flex-1">
              <p class="font-bold text-lg">${u.name}</p>
              <p class="text-sm text-gray-500">${u.email}</p>
              <p class="text-sm text-gray-500">${u.phone}</p>
              <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full ${getStatusColor(u.status)}">${getStatusLabel(u.status)}</span>
              <p class="text-xs text-gray-400 mt-1">Inscrit le ${new Date(u.createdAt).toLocaleDateString('fr-FR')}</p>
              ${hasProof ? `
                <div class="mt-3 p-3 bg-orange-50 rounded-lg">
                  <p class="text-sm font-semibold text-orange-700 mb-2">üì∏ Preuve de paiement :</p>
                  <img src="${u.paymentProof.screenshot}" class="w-full max-w-xs rounded-lg border cursor-pointer" onclick="openImageFullscreen('${u.paymentProof.screenshot.replace(/'/g, "\\'")}')" alt="Preuve de paiement" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <p class="text-xs text-red-500 hidden">Image non disponible</p>
                  ${u.paymentProof.transactionId ? `<p class="text-xs text-gray-500 mt-1">ID: ${u.paymentProof.transactionId}</p>` : ''}
                  <p class="text-xs text-gray-500">Tel: ${u.paymentProof.phoneUsed || 'Non renseign√©'}</p>
                  <p class="text-xs text-gray-400">Envoy√© le: ${u.paymentProof.submittedAt ? new Date(u.paymentProof.submittedAt).toLocaleString('fr-FR') : 'N/A'}</p>
                </div>
              ` : `
                <div class="mt-3 p-3 bg-gray-100 rounded-lg">
                  <p class="text-sm text-gray-500">‚ö†Ô∏è Aucune preuve de paiement envoy√©e</p>
                </div>
              `}
            </div>
            <div class="flex sm:flex-col gap-2">
              <button onclick="validateUser('${getId(u)}')" class="btn-success text-sm px-4 py-2 flex-1">‚úì Valider</button>
              <button onclick="rejectUser('${getId(u)}')" class="btn-danger text-sm px-4 py-2 flex-1">‚úó Refuser</button>
            </div>
          </div>
        </div>
      `}).join('');
    }
    
    // Ouvrir l'image en plein √©cran
    function openImageFullscreen(imageSrc) {
      const modal = $('#modal');
      modal.innerHTML = `
        <div class="modal" onclick="closeModal(event)" style="background: rgba(0,0,0,0.9);">
          <div onclick="event.stopPropagation()" style="max-width: 95vw; max-height: 95vh;">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-3xl z-50">&times;</button>
            <img src="${imageSrc}" class="max-w-full max-h-screen rounded-lg" alt="Preuve de paiement">
          </div>
        </div>
      `;
    }

    function renderAdminUsers() {
      return `
        <div class="card">
          <p class="text-sm text-gray-500 mb-3">Total: ${state.adminData.users.length} utilisateurs</p>
          <div class="space-y-2">
            ${state.adminData.users.map(u => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <div>
                  <p class="font-semibold">${u.name} ${u.isAdmin ? 'üëë' : ''}</p>
                  <p class="text-xs text-gray-500">${u.email}</p>
                  <p class="text-xs text-gray-500">${u.earnings} FCFA gagn√©s ‚Ä¢ ${u.completedTasks?.length || 0} t√¢ches ‚Ä¢ ${u.watchedVideos?.length || 0} vid√©os</p>
                </div>
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColor(u.status)}">${getStatusLabel(u.status)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderAdminWithdrawals() {
      if (state.adminData.withdrawals.length === 0) {
        return '<div class="card text-center text-gray-500 py-8">Aucune demande de retrait</div>';
      }
      return state.adminData.withdrawals.map(w => `
        <div class="card mb-3">
          <div class="flex flex-col sm:flex-row sm:justify-between gap-3">
            <div>
              <p class="font-bold text-xl text-orange-600">${w.amount} FCFA</p>
              <p class="font-semibold">${w.userName}</p>
              <p class="text-sm text-gray-500">${w.method === 'moov' ? 'Moov Money' : 'Mix by Yas'}</p>
              <p class="text-sm text-gray-600">üì± ${w.accountNumber}</p>
              <p class="text-sm text-gray-500">Nom: ${w.accountName}</p>
              <p class="text-xs text-gray-400">${new Date(w.createdAt).toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="flex flex-col gap-2 items-end">
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(w.status)}">${getStatusLabel(w.status)}</span>
              ${w.status === 'pending' ? `
                <button onclick="approveWithdraw('${getId(w)}')" class="btn-success text-sm px-4 py-2">‚úì Approuver</button>
                <button onclick="rejectWithdraw('${getId(w)}')" class="btn-danger text-sm px-4 py-2">‚úó Refuser</button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAdminVideos() {
      return `
        <div class="card mb-4">
          <h2 class="font-bold text-lg mb-4">‚ûï Ajouter une vid√©o</h2>
          <form id="addVideoForm">
            <div class="grid grid-cols-2 gap-3 mb-3">
              <select id="videoPlatform" class="input mb-0" required>
                <option value="youtube">YouTube</option>
                <option value="tiktok">TikTok</option>
              </select>
              <input type="number" id="videoDuration" class="input mb-0" placeholder="Dur√©e (minutes)" min="1" required>
            </div>
            <input type="text" id="videoTitle" class="input" placeholder="Titre de la vid√©o" required>
            <input type="text" id="videoUrl" class="input" placeholder="URL de la vid√©o (YouTube ou TikTok)" required>
            <input type="number" id="videoReward" class="input" placeholder="R√©compense (FCFA)" min="1" required>
            <button type="submit" class="btn-primary w-full">Ajouter la vid√©o</button>
          </form>
        </div>
        
        <div class="card">
          <h2 class="font-bold text-lg mb-4">üé¨ Vid√©os existantes (${state.adminData.videos.length})</h2>
          ${state.adminData.videos.length === 0 ? '<p class="text-gray-500 text-sm text-center py-4">Aucune vid√©o</p>' : `
            <div class="space-y-3">
              ${state.adminData.videos.map(v => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                  <div>
                    <span class="text-xs px-2 py-1 rounded-full ${v.platform === 'youtube' ? 'bg-red-100 text-red-600' : 'bg-pink-100 text-pink-600'}">
                      ${v.platform === 'youtube' ? 'YouTube' : 'TikTok'}
                    </span>
                    <p class="font-semibold mt-1">${v.title}</p>
                    <p class="text-xs text-gray-500">${v.duration} min ‚Ä¢ ${v.reward} FCFA</p>
                  </div>
                  <button onclick="deleteVideo('${getId(v)}')" class="text-red-500 text-xl">üóëÔ∏è</button>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function renderAdminConfig() {
      const config = state.adminData.config;
      return `
        <div class="card">
          <h2 class="font-bold text-lg mb-4">üì± Num√©ros de paiement</h2>
          <div id="paymentNumbersList">
            ${(config.paymentNumbers || []).map((p, i) => `
              <div class="flex items-center gap-2 mb-3 p-3 bg-gray-50 rounded-lg">
                <div class="flex-1 grid grid-cols-3 gap-2">
                  <input type="text" class="input mb-0 text-sm" value="${p.operator}" placeholder="Op√©rateur" id="op-${i}">
                  <input type="text" class="input mb-0 text-sm" value="${p.number}" placeholder="Num√©ro" id="num-${i}">
                  <input type="text" class="input mb-0 text-sm" value="${p.name}" placeholder="Nom" id="name-${i}">
                </div>
                <button onclick="removePaymentNumber(${i})" class="text-red-500 text-xl px-2">√ó</button>
              </div>
            `).join('')}
          </div>
          <button onclick="addPaymentNumber()" class="text-blue-600 text-sm font-semibold mb-4">+ Ajouter un num√©ro</button>
          <button onclick="savePaymentNumbers()" class="btn-primary w-full">Enregistrer les num√©ros</button>
        </div>
      `;
    }

    // Admin functions
    function addPaymentNumber() {
      state.adminData.config.paymentNumbers.push({ operator: '', number: '', name: '' });
      $('#adminContent').innerHTML = renderAdminConfig();
    }

    function removePaymentNumber(index) {
      state.adminData.config.paymentNumbers.splice(index, 1);
      $('#adminContent').innerHTML = renderAdminConfig();
    }

    async function savePaymentNumbers() {
      const numbers = [];
      state.adminData.config.paymentNumbers.forEach((_, i) => {
        const op = $(`#op-${i}`)?.value;
        const num = $(`#num-${i}`)?.value;
        const name = $(`#name-${i}`)?.value;
        if (op && num) {
          numbers.push({ operator: op, number: num, name: name || '' });
        }
      });
      
      const res = await api('/api/admin/config/payment-numbers', 'POST', { paymentNumbers: numbers });
      if (res.success) {
        toast('Num√©ros enregistr√©s!', 'success');
        state.config.paymentNumbers = numbers;
      } else {
        toast('Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function validateUser(userId) {
      await api(`/api/admin/validate/${userId}`, 'POST');
      toast('Compte valid√©! Commissions vers√©es.', 'success');
      setAdminTab('pending');
    }

    async function rejectUser(userId) {
      await api(`/api/admin/reject/${userId}`, 'POST');
      toast('Compte refus√©', 'info');
      setAdminTab('pending');
    }

    async function approveWithdraw(id) {
      await api(`/api/admin/withdraw/approve/${id}`, 'POST');
      toast('Retrait approuv√©!', 'success');
      setAdminTab('withdrawals');
    }

    async function rejectWithdraw(id) {
      await api(`/api/admin/withdraw/reject/${id}`, 'POST');
      toast('Retrait refus√©, montant rembours√©', 'info');
      setAdminTab('withdrawals');
    }

    async function deleteVideo(videoId) {
      if (!confirm('Supprimer cette vid√©o ?')) return;
      await api(`/api/admin/videos/${videoId}`, 'DELETE');
      toast('Vid√©o supprim√©e', 'info');
      setAdminTab('videos');
    }

    // Attach video form handler
    document.addEventListener('submit', async function(e) {
      if (e.target.id === 'addVideoForm') {
        e.preventDefault();
        const res = await api('/api/admin/videos', 'POST', {
          platform: $('#videoPlatform').value,
          title: $('#videoTitle').value,
          url: $('#videoUrl').value,
          duration: parseInt($('#videoDuration').value),
          reward: parseInt($('#videoReward').value)
        });
        
        if (res.error) {
          toast(res.error, 'error');
        } else {
          toast('Vid√©o ajout√©e!', 'success');
          setAdminTab('videos');
        }
      }
    });

    // Init
    async function init() {
      console.log('Initialisation de Motosu...');
      
      try {
        state.config = await api('/api/config');
        console.log('Config charg√©e:', state.config);
      } catch (e) {
        console.error('Erreur chargement config:', e);
        state.config = { paymentNumbers: [], withdrawMethods: [], subscriptionAmount: 4000 };
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref) {
        localStorage.setItem('referralCode', ref);
        toast('Code parrain enregistr√©: ' + ref, 'success');
        window.history.replaceState({}, '', '/');
      }

      const userId = localStorage.getItem('userId');
      console.log('UserId stock√©:', userId);
      
      if (userId) {
        try {
          const user = await api(`/api/user/${userId}`);
          console.log('Utilisateur r√©cup√©r√©:', user);
          if (user && !user.error) {
            state.currentUser = user;
            if (user.isAdmin) {
              navigate('admin');
            } else if (user.status === 'validated') {
              navigate('dashboard');
            } else {
              navigate('pending');
            }
            return;
          }
        } catch (e) {
          console.error('Erreur r√©cup√©ration user:', e);
        }
      }
      navigate('login');
    }

    // D√©marrer l'app
    console.log('D√©marrage de Motosu Agencies...');
    init().catch(e => {
      console.error('Erreur init:', e);
      navigate('login');
    });
  </script>
</body>
</html>